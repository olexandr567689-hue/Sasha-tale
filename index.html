<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Undertale Sasha - Fixed Edition</title>
    <style>
        :root { --ut-red: #ff0000; --ut-yellow: #ffff00; --ut-green: #00ff00; --ut-blue: #4deeea; }
        body {
            background-color: #000; color: #fff; margin: 0;
            font-family: 'Courier New', Courier, monospace;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; overflow: hidden; touch-action: none;
        }

        #start-screen, #name-screen, #leaderboard-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }

        #btn-z-start {
            width: 80px; height: 80px; background: #222; border: 4px solid var(--ut-yellow); 
            color: var(--ut-yellow); border-radius: 50%; font-size: 30px; font-weight: bold; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        input { background: #000; border: 2px solid #fff; color: #fff; padding: 10px; font-family: inherit; font-size: 20px; text-align: center; margin-bottom: 20px; }
        
        #boss-area { position: relative; margin-top: 50px; height: 120px; display: flex; flex-direction: column; align-items: center; opacity: 0; }
        #enemy-sprite { font-size: 60px; position: relative; }
        
        /* HP –ë–û–°–ê –¢–ï–ü–ï–† –í–ò–î–ò–ú–ï */
        #boss-hp-container { margin-top: 10px; display: flex; flex-direction: column; align-items: center; }
        #boss-hp-bg { width: 120px; height: 12px; background: #444; border: 2px solid #fff; position: relative; }
        #boss-hp-fg { position: absolute; left: 0; top: 0; height: 100%; background: var(--ut-green); width: 100%; transition: width 0.3s; }
        #dmg-num { position: absolute; top: -30px; color: red; font-size: 20px; font-weight: bold; display: none; }

        #battle-screen { position: relative; border: 5px solid #fff; width: 280px; height: 140px; background: #000; display: flex; justify-content: center; align-items: center; opacity: 0; }
        #heart { position: absolute; width: 14px; height: 14px; background: var(--ut-red); display: none; z-index: 10; border-radius: 2px; }

        #stats-area { width: 280px; margin-top: 10px; opacity: 0; font-size: 14px; }
        #menu { display: flex; gap: 4px; width: 310px; margin-top: 10px; opacity: 0; }
        .btn-m { flex: 1; border: 2px solid orange; color: orange; text-align: center; padding: 8px 0; font-size: 10px; font-weight: bold; }
        .btn-m.active { border-color: var(--ut-yellow); color: var(--ut-yellow); background: #332200; }

        #controls { display: flex; width: 100%; justify-content: space-around; align-items: center; margin-top: auto; padding-bottom: 20px; opacity: 0; }
        .d-pad { display: grid; grid-template-columns: repeat(3, 55px); gap: 5px; }
        .d-btn { background: #222; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; border-radius: 8px; height: 55px; }
        #btn-z { width: 80px; height: 80px; background: #222; border: 4px solid var(--ut-yellow); color: var(--ut-yellow); border-radius: 50%; font-size: 28px; font-weight: bold; display: flex; align-items: center; justify-content: center; }

        .bullet { position: absolute; background: #fff; border-radius: 50%; width: 8px; height: 8px; }
        table { width: 80%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
        th, td { border: 1px solid #fff; padding: 5px; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color:var(--ut-yellow)">UNDERTALE</h1>
        <div id="btn-z-start">Z</div>
        <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å Z</p>
    </div>

    <div id="name-screen" style="display:none;">
        <h2>–Ø–ö –¢–ï–ë–ï –ó–í–ê–¢–ò?</h2>
        <input type="text" id="player-name-input" maxlength="8">
        <div id="btn-confirm-name" style="border:2px solid #fff; padding:10px;">OK</div>
    </div>

    <div id="leaderboard-screen" style="display:none;">
        <h2 style="color:var(--ut-green)">–†–ï–ö–û–†–î–ò</h2>
        <table id="leader-table"></table>
        <button onclick="location.reload()" style="margin-top:20px;">–ó–ê–ù–û–í–û</button>
    </div>

    <div id="boss-area">
        <div id="enemy-sprite">üëª</div>
        <div id="boss-hp-container">
            <div id="dmg-num">0</div>
            <div id="boss-hp-bg"><div id="boss-hp-fg"></div></div>
        </div>
    </div>

    <div id="battle-screen">
        <div id="heart"></div>
        <div id="dialog">* –ù–∞–ø—Å—Ç–∞–±–ª—É–∫ –Ω–µ –∑–Ω–∞—î, —â–æ —Ä–æ–±–∏—Ç–∏.</div>
        <div id="attack-bar" style="position:absolute; width:220px; height:100px; border:3px solid #fff; display:none;">
            <div id="slider" style="position:absolute; left:0; top:0; width:10px; height:100%; background:#fff;"></div>
        </div>
    </div>

    <div id="stats-area">
        <span id="display-name">SASHA</span> HP <span id="hp-val">20/20</span>
        <div style="width:100px; height:10px; border:1px solid var(--ut-blue); margin-top:5px;"><div id="mana-fg" style="width:0%; height:100%; background:var(--ut-blue);"></div></div>
    </div>

    <div id="menu">
        <div class="btn-m active" id="m0">–ë–ò–¢–í–ê</div>
        <div class="btn-m" id="m1">–î–Ü–Ø</div>
        <div class="btn-m" id="m2">–ú–ê–ù–ê</div>
        <div class="btn-m" id="m3">–ü–û–©–ê–î–ê</div>
    </div>

    <div id="controls">
        <div class="d-pad">
            <div class="d-btn" style="grid-column:2" id="up">‚ñ≤</div>
            <div class="d-btn" style="grid-column:1" id="left">‚óÄ</div>
            <div class="d-btn" style="grid-column:3" id="right">‚ñ∂</div>
            <div class="d-btn" style="grid-column:2" id="down">‚ñº</div>
        </div>
        <div id="btn-z">Z</div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let phase = 'START', playerName = "SASHA", startTime, hasActed = false;
        let hp = 20, enemyHp = 400, mana = 0, menuIdx = 0, sPos = 0, sDir = 1;
        let px = 130, py = 70;
        const keys = { up: false, down: false, left: false, right: false };

        function playNote(f, d) {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.frequency.value = f; g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + d);
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime + d);
        }

        document.getElementById('btn-z-start').onclick = () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('name-screen').style.display = 'flex';
            phase = 'NAME';
        };

        document.getElementById('btn-confirm-name').onclick = () => {
            playerName = document.getElementById('player-name-input').value.toUpperCase() || "SASHA";
            document.getElementById('display-name').innerText = playerName;
            document.getElementById('name-screen').style.display = 'none';
            phase = 'MENU';
            startTime = Date.now();
            ['boss-area', 'battle-screen', 'stats-area', 'menu', 'controls'].forEach(id => document.getElementById(id).style.opacity = '1');
        };

        const setupBtn = (id) => {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', (e) => { e.preventDefault(); if (id === 'btn-z') pressZ(); else keys[id] = true; });
            el.addEventListener('touchend', (e) => { e.preventDefault(); keys[id] = false; });
        };
        ['up','down','left','right','btn-z'].forEach(setupBtn);

        function pressZ() {
            if (phase !== 'MENU' && phase !== 'ATTACK') return;
            
            if (phase === 'MENU') {
                if (menuIdx === 0) { // –ë–ò–¢–í–ê
                    phase = 'ATTACK';
                    document.getElementById('dialog').style.display = 'none';
                    document.getElementById('attack-bar').style.display = 'block';
                    sPos = 0;
                } else if (menuIdx === 1) { // –î–Ü–Ø
                    hasActed = true;
                    document.getElementById('dialog').innerText = "* –¢–∏ —Å–∫–∞–∑–∞–≤ –ø—Ä–∏–≤–∏–¥—É, —â–æ –≤—ñ–Ω –∫—Ä—É—Ç–∏–π. –í—ñ–Ω –∑–∞—à–∞—Ä—ñ–≤—Å—è.";
                    phase = 'BUSY'; setTimeout(enemyTurn, 1500);
                } else if (menuIdx === 2) { // –ú–ê–ù–ê
                    if (mana >= 100) { mana = 0; hp = Math.min(20, hp+5); updateUI(); document.getElementById('dialog').innerText = "* –ú–∞–Ω–∞ –≤–∏–ª—ñ–∫—É–≤–∞–ª–∞ —Ç–µ–±–µ!"; phase = 'BUSY'; setTimeout(enemyTurn, 1000); }
                } else if (menuIdx === 3) { // –ü–û–©–ê–î–ê
                    if (hasActed) { win('SPARE'); } else { document.getElementById('dialog').innerText = "* –ù–∞–ø—Å—Ç–∞–±–ª—É–∫ —â–µ —Å—É–º—É—î."; phase = 'BUSY'; setTimeout(enemyTurn, 1000); }
                }
            } else if (phase === 'ATTACK') {
                const dmg = Math.abs(sPos - 110) < 20 ? 100 : 40;
                enemyHp = Math.max(0, enemyHp - dmg);
                document.getElementById('boss-hp-fg').style.width = (enemyHp/400*100) + '%';
                document.getElementById('dmg-num').innerText = dmg;
                document.getElementById('dmg-num').style.display = 'block';
                phase = 'BUSY';
                document.getElementById('attack-bar').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('dmg-num').style.display = 'none';
                    document.getElementById('dialog').style.display = 'block';
                    if (enemyHp <= 0) win('KILL'); else enemyTurn();
                }, 1000);
            }
        }

        function enemyTurn() {
            phase = 'DODGE'; document.getElementById('dialog').style.display = 'none';
            document.getElementById('heart').style.display = 'block'; px = 130; py = 60;
            let t = 60;
            const iv = setInterval(() => {
                if (t % 10 === 0) spawnBullet();
                if (--t <= 0 || hp <= 0) { 
                    clearInterval(iv); 
                    if (hp > 0) { phase = 'MENU'; document.getElementById('heart').style.display = 'none'; document.getElementById('dialog').style.display = 'block'; document.getElementById('dialog').innerText = "* –¢–≤—ñ–π —Ö—ñ–¥."; }
                    else location.reload();
                }
            }, 100);
        }

        function spawnBullet() {
            const b = document.createElement('div'); b.className = 'bullet';
            document.getElementById('battle-screen').appendChild(b);
            let bx = Math.random()*260, by = -10;
            const m = setInterval(() => {
                by += 4; b.style.left = bx + 'px'; b.style.top = by + 'px';
                const hr = heart.getBoundingClientRect(), br = b.getBoundingClientRect();
                if (Math.hypot(hr.left-br.left, hr.top-br.top) < 35) { mana = Math.min(100, mana+2); updateUI(); }
                if (!(br.left > hr.right || br.right < hr.left || br.top > hr.bottom || br.bottom < hr.top)) { hp--; updateUI(); b.remove(); clearInterval(m); }
                if (by > 140 || phase !== 'DODGE') { b.remove(); clearInterval(m); }
            }, 30);
        }

        function updateUI() {
            document.getElementById('hp-val').innerText = hp + "/20";
            document.getElementById('mana-fg').style.width = mana + "%";
        }

        function win(type) {
            phase = 'WIN';
            const time = ((Date.now() - startTime) / 1000).toFixed(2);
            if (type === 'KILL') {
                let s = JSON.parse(localStorage.getItem('ut_s') || '[]');
                s.push({n: playerName, t: time}); s.sort((a,b) => a.t - b.t);
                localStorage.setItem('ut_s', JSON.stringify(s.slice(0, 5)));
            }
            const table = document.getElementById('leader-table');
            table.innerHTML = '<tr><th>–Ü–ú\'–Ø</th><th>–ß–ê–°</th></tr>';
            JSON.parse(localStorage.getItem('ut_s') || '[]').forEach(i => table.innerHTML += `<tr><td>${i.n}</td><td>${i.t}—Å</td></tr>`);
            document.getElementById('leaderboard-screen').style.display = 'flex';
        }

        function main() {
            if (phase === 'MENU') {
                if (keys.left) { menuIdx = (menuIdx + 3) % 4; keys.left = false; }
                if (keys.right) { menuIdx = (menuIdx + 1) % 4; keys.right = false; }
                [0,1,2,3].forEach(i => document.getElementById('m'+i).classList.toggle('active', i === menuIdx));
            }
            if (phase === 'DODGE') {
                if (keys.up && py > 5) py -= 4; if (keys.down && py < 120) py += 4;
                if (keys.left && px > 5) px -= 4; if (keys.right && px < 260) px += 4;
                heart.style.left = px + 'px'; heart.style.top = py + 'px';
            }
            if (phase === 'ATTACK') { sPos += (6 * sDir); if (sPos > 210 || sPos < 0) sDir *= -1; document.getElementById('slider').style.left = sPos + 'px'; }
            requestAnimationFrame(main);
        }
        main();
    </script>
</body>
</html>

