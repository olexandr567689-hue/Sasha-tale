<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Undertale Sasha - Hard Mode</title>
    <style>
        :root { --ut-red: #ff0000; --ut-yellow: #ffff00; --ut-green: #00ff00; --ut-blue: #4deeea; }
        body { background: #000; color: #fff; margin: 0; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; touch-action: none; }
        
        #screen-wrap { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* –ï–∫—Ä–∞–Ω–∏ */
        .overlay { position: fixed; inset: 0; background: #000; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        
        #btn-z-start { width: 100px; height: 100px; border: 5px solid var(--ut-yellow); color: var(--ut-yellow); border-radius: 50%; font-size: 40px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-top: 20px; box-shadow: 0 0 20px var(--ut-yellow); }

        /* –ë–æ—Å */
        #boss-area { margin-top: 20px; height: 140px; display: flex; flex-direction: column; align-items: center; opacity: 0; }
        #enemy-sprite { font-size: 70px; }
        #boss-hp-bg { width: 140px; height: 15px; background: #444; border: 2px solid #fff; position: relative; margin-top: 10px; }
        #boss-hp-fg { position: absolute; left: 0; top: 0; height: 100%; background: var(--ut-green); width: 100%; }

        /* –ü–æ–ª–µ –±–æ—é */
        #battle-screen { position: relative; border: 5px solid #fff; width: 300px; height: 160px; background: #000; overflow: hidden; opacity: 0; margin-top: 10px; }
        #heart { position: absolute; width: 16px; height: 16px; background: var(--ut-red); display: none; z-index: 10; }
        #dialog { padding: 15px; font-size: 16px; line-height: 1.4; }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        #stats { width: 300px; margin-top: 10px; font-weight: bold; opacity: 0; }
        .mana-bar { width: 100%; height: 8px; border: 1px solid var(--ut-blue); margin-top: 5px; }
        #mana-fg { height: 100%; background: var(--ut-blue); width: 0%; transition: 0.2s; }

        /* –ú–µ–Ω—é */
        #menu { display: flex; gap: 5px; width: 320px; margin-top: 10px; opacity: 0; }
        .btn-m { flex: 1; border: 2px solid orange; color: orange; padding: 10px 0; font-size: 12px; text-align: center; }
        .btn-m.active { background: #332200; color: var(--ut-yellow); border-color: var(--ut-yellow); }

        /* –ö–µ—Ä—É–≤–∞–Ω–Ω—è */
        #controls { margin-top: auto; padding-bottom: 20px; display: flex; width: 100%; justify-content: space-around; align-items: center; opacity: 0; }
        .d-pad { display: grid; grid-template-columns: repeat(3, 60px); gap: 5px; }
        .d-btn { background: #222; border: 2px solid #fff; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 24px; border-radius: 10px; }
        #btn-z { width: 90px; height: 90px; background: #222; border: 4px solid var(--ut-yellow); color: var(--ut-yellow); border-radius: 50%; font-size: 32px; font-weight: bold; display: flex; align-items: center; justify-content: center; }

        .tear { position: absolute; background: #fff; width: 6px; height: 10px; border-radius: 0 0 50% 50%; }
        table { width: 90%; border: 1px solid #fff; margin-top: 10px; border-collapse: collapse; }
        th, td { border: 1px solid #fff; padding: 8px; }
    </style>
</head>
<body>

    <div id="start-screen" class="overlay">
        <h1 style="color:var(--ut-yellow); font-size: 40px;">HARD MODE</h1>
        <div id="btn-z-start">Z</div>
        <p>–ù–ê–¢–ò–°–ù–ò Z –î–õ–Ø –ú–£–ó–ò–ö–ò –¢–ê –°–¢–ê–†–¢–£</p>
    </div>

    <div id="name-screen" class="overlay" style="display:none;">
        <h2>–Ø–ö –¢–ï–ë–ï –ó–í–ê–¢–ò?</h2>
        <input type="text" id="p-name" maxlength="8" style="background:#000; color:#fff; border:2px solid #fff; padding:10px; font-size:20px; text-align:center;">
        <div id="btn-ok" style="margin-top:20px; border:2px solid #fff; padding:10px 40px; cursor:pointer;">OK</div>
    </div>

    <div id="win-screen" class="overlay" style="display:none;">
        <h2 id="win-msg" style="color:var(--ut-green)">–ü–ï–†–ï–ú–û–ì–ê!</h2>
        <p id="your-time"></p>
        <table id="score-table"></table>
        <button onclick="location.reload()" style="margin-top:20px; padding:10px;">–ì–†–ê–¢–ò –ó–ù–û–í–£</button>
    </div>

    <div id="boss-area">
        <div id="enemy-sprite">üëª</div>
        <div id="boss-hp-bg"><div id="boss-hp-fg"></div></div>
    </div>

    <div id="battle-screen">
        <div id="heart"></div>
        <div id="dialog">* –ù–∞–ø—Å—Ç–∞–±–ª—É–∫ –≤–∏–≥–ª—è–¥–∞—î —Å–µ—Ä–π–æ–∑–Ω–∏–º.</div>
        <div id="attack-bar" style="position:absolute; inset:20px; border:3px solid #fff; display:none;">
            <div id="slider" style="position:absolute; left:0; top:0; width:15px; height:100%; background:#fff; box-shadow:0 0 10px #fff;"></div>
        </div>
    </div>

    <div id="stats">
        <span id="stat-name">SASHA</span> LV 19 HP <span id="hp-text">20/20</span>
        <div class="mana-bar"><div id="mana-fg"></div></div>
    </div>

    <div id="menu">
        <div class="btn-m active" id="m0">FIGHT</div>
        <div class="btn-m" id="m1">ACT</div>
        <div class="btn-m" id="m2">ITEM</div>
        <div class="btn-m" id="m3">MERCY</div>
    </div>

    <div id="controls">
        <div class="d-pad">
            <div class="d-btn" style="grid-column:2" id="up">‚ñ≤</div>
            <div class="d-btn" style="grid-column:1" id="left">‚óÄ</div>
            <div class="d-btn" style="grid-column:3" id="right">‚ñ∂</div>
            <div class="d-btn" style="grid-column:2" id="down">‚ñº</div>
        </div>
        <div id="btn-z">Z</div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let phase = 'START', playerName = "SASHA", startTime, actCount = 0;
        let hp = 20, enemyHp = 600, mana = 0, menuIdx = 0, sPos = 0, sDir = 1;
        let px = 140, py = 70;
        const keys = { up: false, down: false, left: false, right: false };

        function playMegalovania() {
            const notes = [
                293, 293, 587, 440, 0, 415, 0, 392, 0, 349, 293, 349, 392,
                261, 261, 587, 440, 0, 415, 0, 392, 0, 349, 293, 349, 392,
                247, 247, 587, 440, 0, 415, 0, 392, 0, 349, 293, 349, 392,
                233, 233, 587, 440, 0, 415, 0, 392, 0, 349, 293, 349, 392
            ];
            let i = 0;
            setInterval(() => {
                if (notes[i % notes.length] > 0) {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'square';
                    osc.frequency.value = notes[i % notes.length];
                    gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.1);
                }
                i++;
            }, 125);
        }

        document.getElementById('btn-z-start').onclick = () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            playMegalovania();
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('name-screen').style.display = 'flex';
        };

        document.getElementById('btn-ok').onclick = () => {
            playerName = document.getElementById('p-name').value.toUpperCase() || "SASHA";
            document.getElementById('stat-name').innerText = playerName;
            document.getElementById('name-screen').style.display = 'none';
            phase = 'MENU';
            startTime = Date.now();
            ['boss-area', 'battle-screen', 'stats', 'menu', 'controls'].forEach(id => document.getElementById(id).style.opacity = '1');
        };

        const setupBtn = (id) => {
            const el = document.getElementById(id);
            el.addEventListener('touchstart', (e) => { e.preventDefault(); if (id === 'btn-z') pressZ(); else keys[id] = true; });
            el.addEventListener('touchend', (e) => { e.preventDefault(); keys[id] = false; });
        };
        ['up','down','left','right','btn-z'].forEach(setupBtn);

        function pressZ() {
            if (phase === 'MENU') {
                if (menuIdx === 0) {
                    phase = 'ATTACK';
                    document.getElementById('dialog').style.display = 'none';
                    document.getElementById('attack-bar').style.display = 'block';
                    sPos = 0;
                } else if (menuIdx === 1) {
                    actCount++;
                    document.getElementById('dialog').innerText = "* –¢–∏ —Å–∫–∞–∑–∞–≤ –ù–∞–ø—Å—Ç–∞–±–ª—É–∫—É, —â–æ –≤—ñ–Ω –≤–∏–≥–ª—è–¥–∞—î —è–∫ —Å–ø—Ä–∞–≤–∂–Ω—è –∑—ñ—Ä–∫–∞!";
                    phase = 'BUSY'; setTimeout(enemyTurn, 1500);
                } else if (menuIdx === 2) {
                    if (mana >= 100) { hp = 20; mana = 0; updateUI(); document.getElementById('dialog').innerText = "* –ü–æ–≤–Ω–∏–π —Ö—ñ–ª!"; phase = 'BUSY'; setTimeout(enemyTurn, 1000); }
                } else if (menuIdx === 3) {
                    if (actCount >= 3) win('MERCY');
                    else { document.getElementById('dialog').innerText = "* –í—ñ–Ω —â–µ –Ω–µ —Ö–æ—á–µ –π—Ç–∏..."; phase = 'BUSY'; setTimeout(enemyTurn, 1000); }
                }
            } else if (phase === 'ATTACK') {
                const dmg = Math.abs(sPos - 130) < 25 ? 120 : 50;
                enemyHp = Math.max(0, enemyHp - dmg);
                document.getElementById('boss-hp-fg').style.width = (enemyHp/600*100) + '%';
                phase = 'BUSY';
                document.getElementById('attack-bar').style.display = 'none';
                document.getElementById('dialog').style.display = 'block';
                document.getElementById('dialog').innerText = "* –ù–∞–Ω–µ—Å–µ–Ω–æ " + dmg + " —à–∫–æ–¥–∏!";
                setTimeout(() => { if (enemyHp <= 0) win('KILL'); else enemyTurn(); }, 1000);
            }
        }

        function enemyTurn() {
            phase = 'DODGE';
            document.getElementById('dialog').style.display = 'none';
            document.getElementById('heart').style.display = 'block';
            px = 140; py = 70;
            let time = 70;
            const attackInterval = setInterval(() => {
                spawnTear();
                if (--time <= 0 || hp <= 0) {
                    clearInterval(attackInterval);
                    if (hp > 0) {
                        phase = 'MENU';
                        document.getElementById('heart').style.display = 'none';
                        document.getElementById('dialog').style.display = 'block';
                        document.getElementById('dialog').innerText = "* –ô–æ–≥–æ –∞—Ç–∞–∫–∏ —Å—Ç–∞—é—Ç—å —Å–∏–ª—å–Ω—ñ—à–∏–º–∏.";
                    } else { location.reload(); }
                }
            }, 80);
        }

        function spawnTear() {
            const t = document.createElement('div');
            t.className = 'tear';
            document.getElementById('battle-screen').appendChild(t);
            let tx = Math.random() * 280, ty = -10;
            let speed = 4 + Math.random() * 4; // –®–≤–∏–¥–∫—ñ –∞—Ç–∞–∫–∏
            const m = setInterval(() => {
                ty += speed;
                t.style.left = tx + 'px'; t.style.top = ty + 'px';
                const hr = heart.getBoundingClientRect(), tr = t.getBoundingClientRect();
                if (Math.hypot(hr.left-tr.left, hr.top-tr.top) < 40) { mana = Math.min(100, mana + 1.5); updateUI(); }
                if (!(tr.left > hr.right || tr.right < hr.left || tr.top > hr.bottom || tr.bottom < hr.top)) {
                    hp--; updateUI(); t.remove(); clearInterval(m);
                }
                if (ty > 160 || phase !== 'DODGE') { t.remove(); clearInterval(m); }
            }, 25);
        }

        function updateUI() {
            document.getElementById('hp-text').innerText = hp + "/20";
            document.getElementById('mana-fg').style.width = mana + "%";
        }

        function win(type) {
            phase = 'WIN';
            const finalTime = ((Date.now() - startTime) / 1000).toFixed(2);
            document.getElementById('win-msg').innerText = type === 'MERCY' ? "–ü–û–©–ê–î–ê!" : "–ë–û–° –ü–ï–†–ï–ú–û–ñ–ï–ù–ò–ô!";
            document.getElementById('your-time').innerText = "–¢–≤—ñ–π —á–∞—Å: " + finalTime + "—Å";
            
            // –¢–∞–±–ª–∏—Ü—è –ª—ñ–¥–µ—Ä—ñ–≤
            let scores = JSON.parse(localStorage.getItem('ut_v3_scores') || '[]');
            scores.push({name: playerName, time: parseFloat(finalTime)});
            scores.sort((a,b) => a.time - b.time);
            scores = scores.slice(0, 5);
            localStorage.setItem('ut_v3_scores', JSON.stringify(scores));

            const table = document.getElementById('score-table');
            table.innerHTML = '<tr><th>–Ü–ú\'–Ø</th><th>–ß–ê–°</th></tr>';
            scores.forEach(s => {
                table.innerHTML += `<tr><td>${s.name}</td><td>${s.time}—Å</td></tr>`;
            });
            document.getElementById('win-screen').style.display = 'flex';
        }

        function loop() {
            if (phase === 'MENU') {
                if (keys.left) { menuIdx = (menuIdx + 3) % 4; keys.left = false; }
                if (keys.right) { menuIdx = (menuIdx + 1) % 4; keys.right = false; }
                [0,1,2,3].forEach(i => document.getElementById('m'+i).classList.toggle('active', i === menuIdx));
            }
            if (phase === 'DODGE') {
                if (keys.up && py > 5) py -= 5; if (keys.down && py < 140) py += 5;
                if (keys.left && px > 5) px -= 5; if (keys.right && px < 280) px += 5;
                heart.style.left = px + 'px'; heart.style.top = py + 'px';
            }
            if (phase === 'ATTACK') {
                sPos += (8 * sDir);
                if (sPos > 260 || sPos < 0) sDir *= -1;
                document.getElementById('slider').style.left = sPos + 'px';
            }
            requestAnimationFrame(loop);
        }
        loop();
    </script>
</body>
</html>

