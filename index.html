<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Undertale Sasha - Final Edition</title>
    <style>
        :root { --ut-red: #ff0000; --ut-yellow: #ffff00; --ut-green: #00ff00; --ut-blue: #4deeea; }
        body {
            background-color: #000; color: #fff; margin: 0;
            font-family: 'Courier New', Courier, monospace;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; overflow: hidden; touch-action: none;
        }

        #boss-area { position: relative; margin-top: 40px; height: 120px; display: flex; flex-direction: column; align-items: center; }
        #enemy-sprite { font-size: 60px; transition: transform 0.1s; position: relative; }
        
        #boss-hp-container {
            position: absolute; top: -40px; display: none; flex-direction: column; align-items: center; width: 120px;
        }
        #boss-hp-bg { width: 100px; height: 12px; background: #444; border: 2px solid #000; position: relative; }
        #boss-hp-break { position: absolute; right: 0; top: 0; height: 100%; background: red; width: 0%; transition: width 0.4s ease-out; }
        #boss-hp-fg { position: absolute; left: 0; top: 0; height: 100%; background: var(--ut-green); width: 100%; }
        #dmg-num { color: red; font-size: 24px; font-weight: bold; -webkit-text-stroke: 1px white; margin-bottom: 5px; }

        #enemy-bubble {
            position: absolute; background: #fff; color: #000; padding: 5px 10px; border-radius: 10px; 
            font-size: 12px; font-weight: bold; top: 0; right: -85px; display: none; width: 85px; text-align: center; border: 2px solid #000;
        }

        #battle-screen {
            position: relative; border: 5px solid #fff; width: 280px; height: 160px; background: #000;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        #heart { position: absolute; width: 14px; height: 14px; background: var(--ut-red); display: none; z-index: 10; border-radius: 2px; box-shadow: 0 0 8px var(--ut-red); }
        #dialog { width: 90%; font-size: 14px; }

        #stats-area { width: 280px; margin: 10px 0; }
        #stats { display: flex; align-items: center; gap: 10px; font-size: 14px; margin-bottom: 5px; }
        #player-hp-bar { width: 60px; height: 15px; background: var(--ut-red); position: relative; }
        #player-hp-fg { width: 100%; height: 100%; background: var(--ut-yellow); position: absolute; }

        /* –ú–ê–ù–ê-–ë–ê–† –ü–û–í–ï–†–ù–£–í–°–Ø */
        #mana-container { display: flex; align-items: center; gap: 10px; font-size: 12px; color: var(--ut-blue); }
        #mana-bg { width: 100px; height: 8px; background: #002244; border: 1px solid var(--ut-blue); }
        #mana-fg { width: 0%; height: 100%; background: var(--ut-blue); transition: width 0.2s; }

        #menu { display: flex; gap: 4px; width: 310px; }
        .btn-m { flex: 1; border: 2px solid orange; color: orange; text-align: center; padding: 6px 0; font-size: 10px; font-weight: bold; }
        .btn-m.active { border-color: var(--ut-yellow); color: var(--ut-yellow); background: #332200; }

        #controls { display: flex; width: 100%; justify-content: space-around; align-items: center; margin-top: auto; padding-bottom: 20px; }
        .d-pad { display: grid; grid-template-columns: repeat(3, 55px); grid-template-rows: repeat(3, 55px); gap: 4px; }
        .d-btn { background: #222; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; border-radius: 8px; }
        #btn-z { width: 80px; height: 80px; background: #222; border: 4px solid var(--ut-yellow); color: var(--ut-yellow); border-radius: 50%; font-size: 28px; font-weight: bold; display: flex; align-items: center; justify-content: center; }

        .bullet { position: absolute; background: #fff; border-radius: 50%; width: 8px; height: 8px; }

        @keyframes shake {
            0% { transform: translate(2px, 2px); }
            25% { transform: translate(-2px, -2px); }
            50% { transform: translate(2px, -2px); }
            75% { transform: translate(-2px, 2px); }
            100% { transform: translate(0, 0); }
        }
        .shaking { animation: shake 0.1s infinite; }

        #game-over { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 999; }
    </style>
</head>
<body>

    <div id="game-over">
        <h1 style="color:red">STAY DETERMINED</h1>
        <button onclick="location.reload()" style="background:none; border:2px solid #fff; color:#fff; padding:15px;">–ó–ê–ù–û–í–û</button>
    </div>

    <div id="boss-area">
        <div id="boss-hp-container">
            <div id="dmg-num">0</div>
            <div id="boss-hp-bg">
                <div id="boss-hp-break"></div>
                <div id="boss-hp-fg"></div>
            </div>
        </div>
        <div id="enemy-sprite">üëª<div id="enemy-bubble">—è –Ω–æ—Ä–º.</div></div>
    </div>

    <div id="battle-screen">
        <div id="heart"></div>
        <div id="dialog">* –ù–∞–ø—Å—Ç–∞–±–ª—É–∫ –±—É—Ä–º–æ—á–µ –ú–µ–≥–∞–ª–æ–≤–∞–Ω—ñ—é...</div>
        <div id="attack-bar" style="position:absolute; width:240px; height:130px; border:4px solid #fff; display:none; background:#000; z-index:50;">
            <div id="slider" style="position:absolute; left:0; top:0; width:10px; height:100%; background:#fff; box-shadow: 0 0 10px #fff;"></div>
        </div>
    </div>

    <div id="stats-area">
        <div id="stats">
            <span>SASHA</span>
            <div id="player-hp-bar"><div id="player-hp-fg"></div></div>
            <span id="hp-val">20/20</span>
        </div>
        <div id="mana-container">
            <span>MANA</span>
            <div id="mana-bg"><div id="mana-fg"></div></div>
        </div>
    </div>

    <div id="menu">
        <div class="btn-m active" id="m0">–ë–ò–¢–í–ê</div>
        <div class="btn-m" id="m1">–î–Ü–Ø</div>
        <div class="btn-m" id="m2">–ú–ê–ù–ê</div>
        <div class="btn-m" id="m3">–ü–û–©–ê–î–ê</div>
    </div>

    <div id="controls">
        <div class="d-pad">
            <div class="d-btn" id="up" style="grid-column: 2; grid-row: 1;">‚ñ≤</div>
            <div class="d-btn" id="left" style="grid-column: 1; grid-row: 2;">‚óÄ</div>
            <div class="d-btn" id="right" style="grid-column: 3; grid-row: 2;">‚ñ∂</div>
            <div class="d-btn" id="down" style="grid-column: 2; grid-row: 3;">‚ñº</div>
        </div>
        <div id="btn-z">Z</div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let musicStarted = false;
        let hp = 20, enemyMaxHp = 400, enemyHp = 400, mana = 0, phase = 'MENU', menuIdx = 0, hasActed = false;
        let px = 130, py = 70, sPos = 0, sDir = 1;
        const keys = { up: false, down: false, left: false, right: false };
        const enemyQuotes = ["—è —Ç–∏ –º–∏", "—Ç–∏ –ö—Ä—É—Ç", "–º–µ–≥–æ–ª–æ–≤–∞–Ω—ñ—é!!", "–∑ –ù–ì", "—è –Ω–æ—Ä–º."];

        function playNote(freq, dur, type = 'square', vol = 0.05) {
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(vol, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + dur);
            osc.connect(g); g.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        function startMusic() {
            if (musicStarted) return; musicStarted = true;
            const m = [293, 293, 587, 440, 415, 392, 349, 293, 349, 392];
            let i = 0; setInterval(() => { playNote(m[i % m.length], 0.15); i++; }, 150);
        }

        const setupBtn = (id) => {
            const el = document.getElementById(id);
            const start = (e) => { e.preventDefault(); if (audioCtx.state === 'suspended') audioCtx.resume(); startMusic(); if (id === 'btn-z') pressZ(); else keys[id] = true; };
            const end = (e) => { e.preventDefault(); if(id !== 'btn-z') keys[id] = false; };
            el.addEventListener('touchstart', start); el.addEventListener('touchend', end);
            el.addEventListener('mousedown', start); el.addEventListener('mouseup', end);
        };
        ['up','down','left','right','btn-z'].forEach(setupBtn);

        function pressZ() {
            if (phase === 'MENU') {
                if (menuIdx === 0) startAttack();
                else if (menuIdx === 1) { phase = 'BUSY'; hasActed = true; document.getElementById('dialog').innerText = "* –¢–∏ —Å–∫–∞–∑–∞–≤ –ø—Ä–∏–≤–∏–¥—É, —â–æ –≤—ñ–Ω –∫—Ä—É—Ç–∏–π."; setTimeout(enemyTurn, 1000); }
                else if (menuIdx === 2) useMana();
                else if (menuIdx === 3) useMercy();
            } else if (phase === 'ATTACK') finishAttack();
        }

        function startAttack() { phase = 'ATTACK'; document.getElementById('dialog').style.display = 'none'; document.getElementById('attack-bar').style.display = 'block'; sPos = 0; }

        function finishAttack() {
            const dmg = Math.abs(sPos - 120) < 20 ? 85 : 35;
            const prevHpPercent = (enemyHp / enemyMaxHp) * 100;
            enemyHp = Math.max(0, enemyHp - dmg);
            const currentHpPercent = (enemyHp / enemyMaxHp) * 100;

            phase = 'BUSY';
            playNote(80, 0.4, 'sawtooth', 0.2);
            document.getElementById('attack-bar').style.display = 'none';

            const hpCont = document.getElementById('boss-hp-container');
            const hpFg = document.getElementById('boss-hp-fg');
            const hpBrk = document.getElementById('boss-hp-break');
            const sprite = document.getElementById('enemy-sprite');

            document.getElementById('dmg-num').innerText = dmg;
            hpCont.style.display = 'flex';
            hpFg.style.width = currentHpPercent + '%';
            hpBrk.style.width = (prevHpPercent - currentHpPercent) + '%';
            hpBrk.style.left = currentHpPercent + '%';
            
            hpCont.classList.add('shaking');
            sprite.classList.add('shaking');

            setTimeout(() => {
                hpCont.classList.remove('shaking');
                sprite.classList.remove('shaking');
                hpBrk.style.width = '0%';
                setTimeout(() => {
                    hpCont.style.display = 'none';
                    document.getElementById('dialog').style.display = 'block';
                    if (enemyHp <= 0) { sprite.style.opacity = '0'; phase = 'WIN'; } else enemyTurn();
                }, 600);
            }, 500);
        }

        function useMercy() {
            phase = 'BUSY';
            if (hasActed) { document.getElementById('dialog').innerText = "* –¢–∏ –ø–æ—â–∞–¥–∏–≤ –π–æ–≥–æ!"; document.getElementById('enemy-sprite').style.opacity = '0'; phase = 'WIN'; }
            else { document.getElementById('dialog').innerText = "* –í—ñ–Ω —â–µ —Å—É–º—É—î."; setTimeout(enemyTurn, 1000); }
        }

        function useMana() {
            if (mana >= 100) { 
                mana = 0; hp = Math.min(20, hp + 5); 
                document.getElementById('mana-fg').style.width = "0%";
                playNote(600, 0.5, 'sine', 0.1);
                updateUI(); 
                document.getElementById('dialog').innerText = "* –ú–∞–Ω–∞ –≤—ñ–¥–Ω–æ–≤–∏–ª–∞ 5 HP!";
                setTimeout(enemyTurn, 1000); 
            } else {
                document.getElementById('dialog').innerText = "* –ú–∞–Ω–∞ —â–µ –Ω–µ –ø–æ–≤–Ω–∞!";
            }
        }

        function enemyTurn() {
            if (phase === 'WIN') return;
            const bbl = document.getElementById('enemy-bubble');
            bbl.innerText = enemyQuotes[Math.floor(Math.random()*enemyQuotes.length)];
            bbl.style.display = 'block'; setTimeout(() => bbl.style.display = 'none', 1500);

            phase = 'DODGE'; document.getElementById('dialog').style.display = 'none'; document.getElementById('heart').style.display = 'block';
            px = 130; py = 120;
            let t = 100;
            const iv = setInterval(() => {
                if (t % 8 === 0) spawnBullet(Math.random()*260, -10, 0, 4.5);
                if (t % 15 === 0) spawnBullet(-10, Math.random()*140, 5, 0);
                if (--t <= 0 || hp <= 0 || phase === 'WIN') { 
                    clearInterval(iv); 
                    if (hp > 0 && phase !== 'WIN') { 
                        phase = 'MENU'; 
                        document.getElementById('heart').style.display = 'none'; 
                        document.getElementById('dialog').style.display = 'block'; 
                        document.getElementById('dialog').innerText = "* –¢–≤—ñ–π —Ö—ñ–¥.";
                    } 
                }
            }, 100);
        }

        function spawnBullet(x, y, vx, vy) {
            const b = document.createElement('div'); b.className = 'bullet';
            document.getElementById('battle-screen').appendChild(b);
            const m = setInterval(() => {
                x += vx; y += vy; b.style.left = x + 'px'; b.style.top = y + 'px';
                const hr = heart.getBoundingClientRect(), br = b.getBoundingClientRect();
                
                // –ó–ë–Ü–† –ú–ê–ù–ù–ò
                const dist = Math.hypot(hr.left - br.left, hr.top - br.top);
                if (dist < 40 && dist > 15 && phase === 'DODGE') { 
                    mana = Math.min(100, mana + 1); 
                    document.getElementById('mana-fg').style.width = mana + "%";
                }

                if (!(br.left > hr.right || br.right < hr.left || br.top > hr.bottom || br.bottom < hr.top)) { 
                    hp--; updateUI(); playNote(150, 0.1); clearInterval(m); b.remove(); 
                }
                if (y > 170 || y < -30 || x > 300 || x < -30 || phase !== 'DODGE') { clearInterval(m); b.remove(); }
            }, 30);
        }

        function updateUI() {
            document.getElementById('player-hp-fg').style.width = (hp/20*100)+'%';
            document.getElementById('hp-val').innerText = hp + "/20";
            if (hp <= 0) document.getElementById('game-over').style.display = 'flex';
        }

        function main() {
            if (phase === 'MENU') {
                if (keys.left) { menuIdx = (menuIdx + 3) % 4; keys.left = false; }
                if (keys.right) { menuIdx = (menuIdx + 1) % 4; keys.right = false; }
                [0,1,2,3].forEach(i => document.getElementById('m'+i).classList.toggle('active', i === menuIdx));
            }
            if (phase === 'DODGE') {
                if (keys.up && py > 5) py -= 4.5; if (keys.down && py < 140) py += 4.5;
                if (keys.left && px > 5) px -= 4.5; if (keys.right && px < 260) px += 4.5;
                heart.style.left = px + 'px'; heart.style.top = py + 'px';
            }
            if (phase === 'ATTACK') { sPos += (8 * sDir); if (sPos > 230 || sPos < 0) sDir *= -1; document.getElementById('slider').style.left = sPos + 'px'; }
            requestAnimationFrame(main);
        }
        main();
    </script>
</body>
</html>
